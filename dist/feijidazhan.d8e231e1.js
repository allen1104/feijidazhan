var e=class{constructor(e,t,s=30){this.scene=e,this.key=t,this.maxSize=s,this.group=e.physics.add.group({defaultKey:t,maxSize:s})}spawn(e,t){let s=this.group.get(e,t);return s?(s.setActive(!0).setVisible(!0),s.body.enable=!0,s.x=e,s.y=t,s):null}},t={normal:{key:"enemy",hp:1,score:10,speed:()=>Phaser.Math.Between(120,200),destroyAnim:"enemy_destroy",spawnY:-40,spawnX:()=>Phaser.Math.Between(40,400)},boss1:{key:"enemy2",hp:100,score:100,speed:()=>100,destroyAnim:"boss1_destroy",spawnY:-60,spawnX:()=>Phaser.Math.Between(60,400)},boss2:{key:"enemy3",hp:200,score:500,speed:()=>80,destroyAnim:"boss2_destroy",spawnY:-80,spawnX:()=>Phaser.Math.Between(80,400)}};class s extends Phaser.Scene{constructor(){super({key:"GameScene"}),this.player=null,this.bullets=null,this.enemies=null,this.lastEnemyTime=0,this.pool=null,this.score=0,this.scoreText=null,this.isGameOver=!1,this.lives=3,this.livesIcons=[],this.isInvincible=!1,this.invincibleTimer=null}preload(){[["player","me1.png"],["bullet","bullet1.png"],["enemy","enemy1.png"],["bg","background.png"],["life","life.png"],["me_destroy_1","me_destroy_1.png"],["me_destroy_2","me_destroy_2.png"],["me_destroy_3","me_destroy_3.png"],["me_destroy_4","me_destroy_4.png"],["me1","me1.png"],["me2","me2.png"],["enemy1_down1","enemy1_down1.png"],["enemy1_down2","enemy1_down2.png"],["enemy1_down3","enemy1_down3.png"],["enemy1_down4","enemy1_down4.png"],["enemy2","enemy2.png"],["enemy2_down1","enemy2_down1.png"],["enemy2_down2","enemy2_down2.png"],["enemy2_down3","enemy2_down3.png"],["enemy2_down4","enemy2_down4.png"],["enemy3","enemy3_n1.png"],["enemy3_down1","enemy3_down1.png"],["enemy3_down2","enemy3_down2.png"],["enemy3_down3","enemy3_down3.png"],["enemy3_down4","enemy3_down4.png"],["enemy3_down5","enemy3_down5.png"],["enemy3_down6","enemy3_down6.png"]].forEach(([e,t])=>{this.load.image(e,`./assets/images/${t}`)})}create(){this.add.tileSprite(0,0,this.scale.width,this.scale.height,"bg").setOrigin(0),this.createAnimations(),this.createPlayer(),this.createUI(),this.createPools(),this.createEnemies(),this.registerEvents(),this.isGameOver=!1,this.difficultyLevel=1,this.bossWarningBar=this.add.rectangle(this.scale.width/2,60,.8*this.scale.width,48,0xff0000,.7).setOrigin(.5).setDepth(10).setVisible(!1),this.bossWarningBar.setStrokeStyle(4,0xffff00,1),this.bossWarningBar.setAlpha(.7),this.bossWarningText=this.add.text(this.scale.width/2,60,"",{fontSize:"32px",fill:"linear-gradient(90deg, #fff, #ff0, #f00)",fontWeight:"bold",stroke:"#000",strokeThickness:4,shadow:{offsetX:2,offsetY:2,color:"#ff0",blur:8,fill:!0}}).setOrigin(.5).setDepth(11).setVisible(!1)}createAnimations(){this.anims.create({key:"player_fly",frames:[{key:"me1"},{key:"me2"}],frameRate:8,repeat:-1}),this.anims.create({key:"player_destroy",frames:[{key:"me_destroy_1"},{key:"me_destroy_2"},{key:"me_destroy_3"},{key:"me_destroy_4"}],frameRate:10,repeat:0}),this.anims.create({key:"enemy_destroy",frames:[{key:"enemy1_down1"},{key:"enemy1_down2"},{key:"enemy1_down3"},{key:"enemy1_down4"}],frameRate:10,repeat:0}),this.anims.create({key:"boss1_destroy",frames:[{key:"enemy2_down1"},{key:"enemy2_down2"},{key:"enemy2_down3"},{key:"enemy2_down4"}],frameRate:10,repeat:0}),this.anims.create({key:"boss2_destroy",frames:[{key:"enemy3_down1"},{key:"enemy3_down2"},{key:"enemy3_down3"},{key:"enemy3_down4"},{key:"enemy3_down5"},{key:"enemy3_down6"}],frameRate:10,repeat:0})}createPlayer(){this.player=this.physics.add.sprite(this.scale.width/2,this.scale.height-120,"me1").setDepth(1),this.player.setCollideWorldBounds(!0),this.player.setScale(.5),this.player.play("player_fly")}createUI(){this.score=0,this.scoreText=this.add.text(16,16,"分数: 0",{fontSize:"24px",fill:"#fff"}).setDepth(2),this.lives=3,this.livesIcons=[];for(let e=0;e<this.lives;e++){let t=this.add.image(24+40*e,80,"life").setScale(.5).setDepth(2);this.livesIcons.push(t)}}createPools(){this.pool=new e(this,"bullet",50),this.enemyBullets=this.physics.add.group()}createEnemies(){this.enemies=this.physics.add.group(),this.enemyEvent=this.time.addEvent({delay:800,loop:!0,callback:()=>{let e=Phaser.Math.Between(40,this.scale.width-40),t=this.enemies.create(e,-40,"enemy");t.hp=1,t.type="normal";let s=Phaser.Math.Between(1,3);t.pathType=s,t.baseX=e,t.spawnTime=this.time.now,1===s?t.setVelocityY(Phaser.Math.Between(120,200)):2===s?t.setVelocityY(150):3===s&&(t.setVelocityY(160),t.setVelocityX(Phaser.Math.Between(-80,80)))}}),this.scheduleBoss1(),this.scheduleBoss2()}scheduleBoss1(){let e=Phaser.Math.Between(0,4e3);this.time.addEvent({delay:8e3+e,callback:()=>{this.spawnBoss1(),this.scheduleBoss1()}})}scheduleBoss2(){let e=Phaser.Math.Between(0,8e3);this.time.addEvent({delay:2e4+e,callback:()=>{this.spawnBoss2(),this.scheduleBoss2()}})}showBossWarning(e){this.bossWarningBar.setVisible(!0),this.bossWarningText.setText("boss2"===e?"⚡⚡⚡ 大Boss来袭！ ⚡⚡⚡":"小Boss来袭！"),this.bossWarningText.setVisible(!0),this.tweens.add({targets:[this.bossWarningBar,this.bossWarningText],alpha:{from:.7,to:1},duration:300,yoyo:!0,repeat:8}),this.time.delayedCall(3e3,()=>{this.bossWarningBar.setVisible(!1),this.bossWarningText.setVisible(!1)})}spawnBoss1(){let e=Phaser.Math.Between(60,this.scale.width-60),t=this.enemies.create(e,-60,"enemy2");t.setVelocityY(100),t.hp=20,t.type="boss1";let s=Phaser.Math.Between(1,3);t.pathType=s,t.baseX=e,t.spawnTime=this.time.now,3===s&&t.setVelocityX(Phaser.Math.Between(-80,80)),t.shootTimer=this.time.addEvent({delay:1200,loop:!0,callback:()=>{t.active&&this.shootEnemyBullets(t,3)}})}spawnBoss2(){this.showBossWarning("boss2");let e=Phaser.Math.Between(80,this.scale.width-80),t=this.enemies.create(e,-80,"enemy3");t.setVelocityY(80),t.hp=50,t.type="boss2",t.shootTimer=this.time.addEvent({delay:900,loop:!0,callback:()=>{t.active&&this.shootEnemyBullets(t,7)}})}shootEnemyBullets(e,t){for(let s=0;s<t;s++){let i=-30+60/(t-1)*s,n=Phaser.Math.DegToRad(i),a=300*Math.sin(n),l=300*Math.cos(n),h=this.enemyBullets.create(e.x,e.y+40,"bullet");h.setVelocity(a,l),h.setActive(!0).setVisible(!0),h.body.enable=!0}}registerEvents(){this.input.on("pointermove",e=>{this.player.x=Phaser.Math.Clamp(e.x,0,this.scale.width),this.player.y=Phaser.Math.Clamp(e.y,0,this.scale.height)}),this.shootEvent=this.time.addEvent({delay:200,loop:!0,callback:()=>{let e=this.pool.spawn(this.player.x,this.player.y-40);e&&e.setVelocityY(-600)}}),this.cursors=this.input.keyboard.createCursorKeys(),this.physics.add.overlap(this.pool.group,this.enemies,this.hitEnemy,null,this),this.physics.add.overlap(this.player,this.enemies,this.playerHit,null,this)}hitEnemy(e,s){if(e.setActive(!1).setVisible(!1),void 0===s.hp&&(s.hp=1),!s.isDying&&(s.hp--,s.hp<=0)){s.isDying=!0;let e=t[s.type]||t.normal;s.play(e.destroyAnim),s.once("animationcomplete",()=>{s.destroy()}),this.isGameOver||(this.score+=e.score,this.scoreText.setText("分数: "+this.score))}}playerHit(e,t){t.destroy(),this.isInvincible||this.isGameOver||(this.cameras.main.shake(200,.01),this.lives--,this.livesIcons[this.lives]&&this.livesIcons[this.lives].setVisible(!1),this.player.play("player_destroy"),this.player.once("animationcomplete",()=>{if(this.lives<=0)return void this.gameOver();this.player.setY(this.scale.height+60),this.player.setX(this.scale.width/2),this.player.setActive(!0).setVisible(!0),this.player.play("player_fly"),this.tweens.add({targets:this.player,y:this.scale.height-120,duration:600,ease:"Power2",onComplete:()=>{this.isInvincible=!0,this.player.setAlpha(.5),this.invincibleTimer&&this.invincibleTimer.remove(!1),this.invincibleTimer=this.time.addEvent({delay:3e3,callback:()=>{this.isInvincible=!1,this.player.setAlpha(1)}})}})}))}gameOver(){if(this.isGameOver=!0,this.player.setActive(!1).setVisible(!1),this.shootEvent.remove(!1),this.enemyEvent.remove(!1),this.physics.pause(),window&&window.parent){let e=new CustomEvent("gameover",{detail:{score:this.score}});window.dispatchEvent(e)}}updateDifficulty(){let e=Math.floor(this.score/200)+1;if(e!==this.difficultyLevel){this.difficultyLevel=e,this.enemyEvent&&this.enemyEvent.remove(!1);let t=Math.max(800-(this.difficultyLevel-1)*100,300);this.enemyEvent=this.time.addEvent({delay:t,loop:!0,callback:()=>{let e=Phaser.Math.Between(40,this.scale.width-40),t=this.enemies.create(e,-40,"enemy");t.setVelocityY(Phaser.Math.Between(120,200)+(this.difficultyLevel-1)*30),t.hp=1,t.type="normal"}})}}update(){this.player&&this.player.active&&this.cursors&&(this.cursors.left.isDown?this.player.setVelocityX(-300):this.cursors.right.isDown?this.player.setVelocityX(300):this.player.setVelocityX(0)),this.isInvincible&&this.player&&this.player.active&&this.player.setAlpha(Math.sin(this.time.now/100)>0?.5:1),this.enemies.children.iterate(e=>{e&&e.active&&(2===e.pathType&&(e.x=e.baseX+60*Math.sin((this.time.now-e.spawnTime)/400)),e.y>this.scale.height+40&&e.destroy())}),this.pool.group.children.iterate(e=>{e&&e.active&&e.y<-40&&(e.setActive(!1).setVisible(!1),e.body.enable=!1)}),this.enemyBullets.children.iterate(e=>{e&&e.active&&e.y>this.scale.height+40&&(e.setActive(!1).setVisible(!1),e.body.enable=!1,e.destroy())}),this.updateDifficulty()}}window.onload=function(){let e=document.getElementById("startBtn"),t=document.getElementById("startScreen"),i=document.getElementById("gameOverScreen"),n=document.getElementById("finalScore"),a=document.getElementById("restartBtn"),l=document.getElementById("playerName"),h=document.getElementById("playerNameEnd"),o=document.getElementById("confirmNameBtn"),r=document.getElementById("congratsModal"),y=document.getElementById("rankListStartItems"),d=document.getElementById("rankListEndItems"),c=document.getElementById("rankListEnd"),m=null,p="",w=0,g="";function u(){if(m){m.destroy(!0),m=null;let e=document.getElementById("game-container");e&&(e.innerHTML="")}let e={type:Phaser.AUTO,width:window.innerWidth,height:window.innerHeight,parent:"game-container",physics:{default:"arcade",arcade:{debug:!1}},scene:[s]};m=new Phaser.Game(e)}async function f(){try{let e=await fetch("http://101.126.133.7:18682/rankings");if(e.ok)return await e.json()}catch{}return[]}async function v(){try{let e=navigator.userAgent,t="";l&&l.value.trim()?t=l.value.trim():p&&(t=p),await fetch("http://101.126.133.7:18682/game_start_logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({player_name:t,ip:"",browser:e})})}catch{}}async function _(e,t){try{await fetch("http://101.126.133.7:18682/rankings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({player_name:e,score:t})})}catch{}}async function b(e,t){var s;s=await f(),e&&(e.innerHTML="",s.forEach(s=>{let i=document.createElement("li");i.textContent=`${s.player_name} - ${s.score}`,t&&s.player_name===t&&(i.style.color="#ffd700",i.style.fontWeight="bold"),e.appendChild(i)}))}b(y),e&&t&&e.addEventListener("click",async function(){p="",t.style.display="none",await v(),await b(y),u()}),window.addEventListener("gameover",async function(e){if(i&&n){let t=e.detail.score||0;w=t,n.textContent="最终得分："+t;let s=await f();t>(s.length<10?0:s[9].score)||s.length<10?r&&h&&o&&(r.style.display="flex",c.style.display="none",h.value="",h.focus(),g=""):(r.style.display="none",c.style.display="flex",g="",await b(d,g)),i.style.display="flex"}}),o&&o.addEventListener("click",async function(){let e=h.value.trim();if(!e)return void h.focus();await _(e,w),g=e,await b(d,g),r.style.display="none",c.style.display="flex"}),a&&a.addEventListener("click",async function(){i&&(i.style.display="none"),r&&(i.style.display="none"),c&&(c.style.display="none"),await v(),await b(y),u()})};
//# sourceMappingURL=feijidazhan.d8e231e1.js.map
